library(tidyverse)
library(ompr)
library(ompr.roi)
library(ROI.plugin.glpk)

cost_matrix <- matrix(c(0, 100, 60, 100, 100, 400, 400,
                        180, 0, 180, 20, 20, 160, 300,
                        8, 160, 0, 20, 10, 200, 240,
                        0, 0, 0, 0, 24, 40, 240,
                        0, 0, 0, 16, 0, 40, 240,
                        0, 0, 0, 0, 0, 0, 20,
                        0, 0, 0, 0, 0, 140, 0), nrow = 7, ncol = 7, byrow = TRUE)

model <- MIPModel() %>%
  add_variable(x[i, j], i = 1:7, j = 1:7, type = "integer", lb = 0) %>%
  set_objective(sum_expr(cost_matrix[i, j] * x[i, j], i = 1:7, j = 1:7), "min") %>%
    add_constraint(sum_expr(x[1, j], j = 1:7) - sum_expr(x[i, 1], i = 1:7) <= 400000) %>%
    add_constraint(sum_expr(x[2, j], j = 1:7) - sum_expr(x[i, 2], i = 1:7) <= 600000) %>%
    add_constraint(sum_expr(x[3, j], j = 1:7) - sum_expr(x[i, 3], i = 1:7) <= 200000) %>%
    add_constraint(sum_expr(x[4, j], j = 1:7) == sum_expr(x[i, 4], i = 1:7)) %>%
    add_constraint(sum_expr(x[5, j], j = 1:7) == sum_expr(x[i, 5], i = 1:7)) %>%
    add_constraint(sum_expr(x[6, j], j = 1:7) - sum_expr(x[i, 6], i = 1:7) == -400000) %>%
    add_constraint(sum_expr(x[7, j], j = 1:7) - sum_expr(x[i, 7], i = 1:7) == -180000) %>%
  add_constraint(x[i, j] <= 400000, i = 1:7, j = 1:7) %>%
  add_constraint(x[i, j] >= 0, i = 1:7, j = 1:7)

result <- solve_model(model, with_ROI(solver = "glpk", verbose = TRUE))

solution <- result$solution
cat("Objective value:", result$objective, "\n")
cat("Optimal solution:", "\n")
print(solution)

library(lpSolve)

objective.in <- c(100,60,100,100,400,400,
                  180,180,20,20,160,300,
                  8,160,20,10,200,240,
                  24,40,240,
                  16,40,240,
                  20,140)

const.mat <- matrix(
                    c(1,1,1,1,1,1,-1,0,0,0,0,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,0, #Node1
                      -1,0,0,0,0,0,1,1,1,1,1,1,0,-1,0,0,0,0,0,0,0,0,0,0,0,0, #Node2
                      0,-1,0,0,0,0,0,-1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0, #Node3
                      0,0,-1,0,0,0,0,0,-1,0,0,0,0,0,-1,0,0,0,1,1,1,-1,0,0,0,0, #Node4
                      0,0,0,-1,0,0,0,0,0,-1,0,0,0,0,0,-1,0,0,-1,0,0,1,1,1,0,0, #Node5
                      0,0,0,0,-1,0,0,0,0,0,-1,0,0,0,0,0,-1,0,0,-1,0,0,-1,0,1,-1, #Node6
                      0,0,0,0,0,-1,0,0,0,0,0,-1,0,0,0,0,0,-1,0,0,-1,0,0,-1,-1,1, #Node7
                      1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, #capacity constraints
                      0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
                      1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, #non-negativity constraints
                      0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
                      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1),
                    nrow=59, byrow=TRUE
                    )

const.dir <- c(rep('<=',3),
               rep('=',4),
               rep('<=',26),
               rep('>=',26)
              )

const.rhs <- c(400000,
               600000,
               200000,
               0,
               0,
               -400000,
               -180000,
               rep(400000,26),
               rep(0,26)
              )

lp(direction="min",objective.in,const.mat,const.dir,
      const.rhs,all.int=TRUE)

lp(direction="min",objective.in,const.mat,const.dir,
      const.rhs,all.int=TRUE)$solution
